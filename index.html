<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â≤°Â±±Êº´ÊóÖ V2 | Okayama Trip</title>
    
    <!-- Ê†∏ÂøÉÂ∫´ -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ÊãñÊõ≥ÊéíÂ∫èÂ∫´ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- Âú∞ÂúñÂ∫´ (Áî® Leaflet Ê®°Êì¨Ë¶ñË¶∫Ôºå‰ΩÜÂ∞éËà™‰∏≤Êé• Google Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- ÂúñÊ®ô -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Â≠óÈ´î (Êó•Á≥ªÂúìÈ´î) -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #FEFCE8; /* Ê∑°ÈªÉËâ≤ */
            color: #4B5563;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* Èò≤Ê≠¢ÊâãÊ©ü‰∏ãÊãâÂà∑Êñ∞ */
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Â∞éËà™Ê¨ÑÊøÄÊ¥ªÊ®£Âºè */
        .nav-item.active { color: #D97706; }
        .nav-item.active i { transform: translateY(-4px); transition: transform 0.2s; }

        /* ÊãñÊõ≥ÊôÇÁöÑÊ®£Âºè */
        .sortable-ghost { opacity: 0.4; background: #FDE68A; }
        .sortable-drag { cursor: grabbing; opacity: 1; background: white; transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FCD34D', // Ê∫´ÊöñÈªÉ
                        secondary: '#FFFBEB', // Á±≥ÁôΩ
                        accent: '#F59E0B', // Ê∑±ÈªÉ
                        dark: '#374151',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-[#FEFCE8]">

    <div id="app" class="h-full flex flex-col relative">

        <!-- È†ÇÈÉ® Header -->
        <header class="bg-secondary/95 backdrop-blur-md px-4 py-3 shadow-sm z-30 flex justify-between items-center border-b border-yellow-100">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white font-bold">Â≤°</div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800 leading-tight">Â≤°Â±±Êº´ÊóÖ</h1>
                    <p class="text-[10px] text-gray-500">{{ headerTitle }}</p>
                </div>
            </div>
            <!-- Âè≥‰∏äËßíÂäüËÉΩÂçÄ -->
            <div class="flex gap-3">
                <!-- Ë≥ºÁâ©Ê∏ÖÂñÆÊåâÈàï -->
                <button @click="showShoppingModal = true" class="relative text-gray-600 hover:text-accent transition">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span v-if="shoppingList.filter(i=>!i.done).length > 0" class="absolute -top-1 -right-2 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center">
                        {{ shoppingList.filter(i=>!i.done).length }}
                    </span>
                </button>
            </div>
        </header>

        <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄ -->
        <main class="flex-1 overflow-hidden relative">

            <!-- 1. TODO ÂæÖËæ¶‰∫ãÈ†ÖÈ†Å -->
            <div v-if="currentTab === 'todo'" class="h-full overflow-y-auto p-4 pb-24">
                <h2 class="text-xl font-bold mb-4 pl-2 border-l-4 border-primary text-gray-700">Âá∫ÁôºÂâçÊ∫ñÂÇô</h2>
                
                <!-- Êñ∞Â¢ûÂæÖËæ¶ -->
                <div class="flex gap-2 mb-6">
                    <input v-model="newTodoText" @keyup.enter="addTodo" placeholder="Ëº∏ÂÖ•ÂæÖËæ¶‰∫ãÈ†Ö..." class="flex-1 bg-white border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-primary shadow-sm">
                    <button @click="addTodo" class="bg-gray-800 text-white w-12 rounded-xl shadow-md"><i class="fas fa-plus"></i></button>
                </div>

                <div class="space-y-3">
                    <div v-for="(todo, idx) in todos" :key="idx" 
                         class="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between border border-gray-50 transition-all"
                         :class="{'opacity-60 grayscale': todo.done}">
                        <div class="flex items-center gap-3 flex-1" @click="todo.done = !todo.done">
                            <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors"
                                 :class="todo.done ? 'bg-green-500 border-green-500' : 'border-gray-300'">
                                <i v-if="todo.done" class="fas fa-check text-white text-xs"></i>
                            </div>
                            <span :class="{'line-through text-gray-400': todo.done}" class="font-medium">{{ todo.text }}</span>
                        </div>
                        <button @click="todos.splice(idx, 1)" class="text-gray-300 hover:text-red-400 px-2"><i class="fas fa-times"></i></button>
                    </div>
                </div>

                <!-- Ë≥ºÁâ©Ê∏ÖÂñÆÈ†êË¶ΩÂçÄÂ°ä -->
                <div class="mt-8 bg-yellow-50 rounded-2xl p-4 border border-yellow-100">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-yellow-800"><i class="fas fa-shopping-bag mr-1"></i> Ë≥ºÁâ©Ê∏ÖÂñÆÈ†êË¶Ω</h3>
                        <button @click="showShoppingModal = true" class="text-xs bg-white px-2 py-1 rounded shadow text-yellow-600">ÁÆ°ÁêÜ</button>
                    </div>
                    <div class="text-sm text-gray-500" v-if="shoppingList.length === 0">Â∞öÊú™Êñ∞Â¢ûË≥ºÁâ©Ê∏ÖÂñÆ</div>
                    <div class="flex flex-wrap gap-2">
                        <span v-for="item in shoppingList.slice(0, 5)" :key="item.id" class="text-xs px-2 py-1 bg-white rounded-md border border-yellow-200" :class="{'line-through opacity-50': item.done}">
                            {{ item.text }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- 2. Ë°åÁ®ãË°® (Ê†∏ÂøÉÂäüËÉΩ) -->
            <div v-show="currentTab === 'schedule'" class="h-full flex flex-col">
                <!-- Ê©´ÂêëÊó•ÊúüÈÅ∏ÂñÆ -->
                <div class="bg-[#FEFCE8] pt-2 pb-1 px-2 shadow-sm z-10">
                    <div class="flex space-x-2 overflow-x-auto hide-scrollbar snap-x py-2 px-2">
                        <div v-for="(day, index) in itinerary" :key="index" @click="switchDay(index)"
                            class="snap-center flex-shrink-0 flex flex-col items-center justify-center w-[64px] h-[72px] rounded-xl transition-all duration-300 border cursor-pointer relative"
                            :class="currentDayIndex === index ? 'bg-primary text-white border-primary shadow-md scale-105' : 'bg-white text-gray-400 border-gray-100'">
                            <span class="text-[10px] font-medium">{{ day.shortDate }}</span>
                            <span class="text-lg font-bold font-mono">{{ day.dayLabel }}</span>
                            <div v-if="currentDayIndex === index" class="absolute -bottom-1 w-1 h-1 bg-white rounded-full"></div>
                        </div>
                    </div>
                </div>

                <!-- Ë°åÁ®ãÂàóË°® (ÂèØÊãñÊõ≥) -->
                <div class="flex-1 overflow-y-auto px-4 pb-24 hide-scrollbar pt-4" ref="sortableContainer">
                    <div v-if="currentItinerary.events.length === 0" class="text-center py-20 text-gray-400 flex flex-col items-center">
                        <i class="fas fa-map-signs text-4xl mb-3 text-gray-200"></i>
                        <p>ÈªûÊìäÂè≥‰∏ãËßí + ÈñãÂßãË¶èÂäÉË°åÁ®ã</p>
                    </div>

                    <div v-for="(event, idx) in currentItinerary.events" :key="event.id" :data-id="event.id"
                        class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4 relative group hover:shadow-md transition-all">
                        
                        <!-- ÊãñÊõ≥ÊääÊâã -->
                        <div class="absolute top-2 right-2 text-gray-200 p-2 cursor-grab handle">
                            <i class="fas fa-grip-lines"></i>
                        </div>

                        <!-- ‰∏ªË¶ÅÂÖßÂÆπ -->
                        <div class="flex gap-3">
                            <!-- ÊôÇÈñìËàáÂàÜÈ°ûÂúñÁ§∫ -->
                            <div class="flex flex-col items-center min-w-[50px]">
                                <div class="text-lg font-bold font-mono text-gray-700">{{ event.time }}</div>
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm mt-1 shadow-sm"
                                     :class="getCategoryColor(event.category)">
                                    <i :class="getCategoryIcon(event.category)"></i>
                                </div>
                                <div v-if="event.weather" class="mt-2 text-[10px] text-gray-400 flex flex-col items-center">
                                    <i class="fas fa-cloud text-blue-300 mb-0.5"></i>
                                    {{ event.weather }}¬∞
                                </div>
                            </div>

                            <!-- Ë©≥Á¥∞Ë≥áË®ä -->
                            <div class="flex-1 pr-6">
                                <h3 class="font-bold text-gray-800 text-lg leading-tight mb-1">{{ event.title }}</h3>
                                
                                <!-- Âú∞ÈªûËàáÂ∞éËà™ -->
                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                    <span class="text-sm text-gray-500 bg-gray-50 px-2 py-0.5 rounded-md truncate max-w-[150px]">
                                        <i class="fas fa-map-marker-alt text-red-400 mr-1"></i>{{ event.location }}
                                    </span>
                                    <a :href="getGoogleNavUrl(event.location)" target="_blank" 
                                       class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full border border-blue-100 flex items-center hover:bg-blue-100">
                                        <i class="fas fa-location-arrow mr-1"></i> Â∞éËà™
                                    </a>
                                </div>

                                <!-- ÂÇôË®ª -->
                                <div v-if="event.note" class="text-xs text-gray-500 bg-yellow-50/50 p-2 rounded-lg border border-yellow-100/50 mb-2">
                                    {{ event.note }}
                                </div>

                                <!-- ÊôØÈªûÂ∞àÂ±¨Ê¨Ñ‰Ωç -->
                                <div v-if="event.category === 'sightseeing'" class="mt-3 pt-2 border-t border-gray-100 grid gap-2">
                                    <!-- ÈôÑËøëÊé®Ëñ¶ -->
                                    <div v-if="event.restaurant" class="flex items-start gap-2 text-xs text-gray-600">
                                        <i class="fas fa-utensils text-orange-400 mt-0.5"></i>
                                        <span><b class="text-gray-400">È£üÔºö</b>{{ event.restaurant }}</span>
                                    </div>
                                    <div v-if="event.toilet" class="flex items-start gap-2 text-xs text-gray-600">
                                        <i class="fas fa-restroom text-blue-400 mt-0.5"></i>
                                        <span><b class="text-gray-400">ÂªÅÔºö</b>{{ event.toilet }}</span>
                                    </div>
                                    <!-- ÊâìÂãæÁ¢∫Ë™ç -->
                                    <div class="flex items-center mt-1">
                                        <label class="flex items-center gap-2 cursor-pointer select-none">
                                            <div class="w-4 h-4 border rounded flex items-center justify-center transition"
                                                 :class="event.isDone ? 'bg-green-500 border-green-500' : 'border-gray-300'">
                                                <i v-if="event.isDone" class="fas fa-check text-white text-[10px]"></i>
                                            </div>
                                            <span class="text-xs text-gray-400" :class="{'line-through': event.isDone}">Â∑≤ÂÆåÊàê</span>
                                        </label>
                                        <input type="checkbox" v-model="event.isDone" class="hidden">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Á∑®ËºØÊåâÈàï -->
                        <div class="absolute bottom-2 right-2 flex gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition">
                            <button @click="editEvent(idx)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center"><i class="fas fa-pen text-xs"></i></button>
                            <button @click="deleteEvent(idx)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 hover:bg-red-50 hover:text-red-500 flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Êá∏ÊµÆÊñ∞Â¢ûÊåâÈàï -->
                <button @click="openAddModal" class="absolute bottom-6 right-6 w-14 h-14 bg-gray-800 text-white rounded-full shadow-xl flex items-center justify-center text-2xl hover:scale-110 transition z-20 active:bg-gray-900">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <!-- 3. Ë®òÂ∏≥ (Wallet) -->
            <div v-if="currentTab === 'wallet'" class="h-full flex flex-col bg-white">
                <!-- Á∏ΩË≥áÁî¢Ê¶ÇË¶Ω -->
                <div class="bg-primary px-6 py-6 pb-8 rounded-b-[2rem] shadow-sm text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl"><i class="fas fa-wallet"></i></div>
                    <div class="text-sm opacity-90 mb-1">È†ê‰º∞Á∏ΩÊîØÂá∫ (TWD)</div>
                    <div class="text-4xl font-bold font-mono tracking-wide">NT$ {{ grandTotalTWD.toLocaleString() }}</div>
                    
                    <div class="flex items-center gap-4 mt-4 bg-white/20 p-2 rounded-xl backdrop-blur-sm w-fit px-4">
                        <span class="text-xs">ÂåØÁéáË®≠ÂÆö</span>
                        <div class="flex items-center gap-1">
                            <span class="text-xs">JPY 1 = TWD</span>
                            <input v-model.number="exchangeRate" type="number" step="0.001" class="w-14 bg-transparent border-b border-white text-center font-bold focus:outline-none">
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto px-4 py-4 pb-24">
                    <!-- ÂàÜÂ§©Áµ±Ë®à -->
                    <div v-for="(dayExpenses, dayKey) in expensesByDay" :key="dayKey" class="mb-6">
                        <h3 class="font-bold text-gray-700 mb-2 border-l-4 border-accent pl-2 text-sm flex justify-between">
                            {{ dayKey }}
                            <span class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-500">
                                ÂêàË®à: NT${{ calculateDayTotalTWD(dayExpenses).toLocaleString() }}
                            </span>
                        </h3>
                        <div class="space-y-2">
                            <div v-for="(item, i) in dayExpenses" :key="i" class="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-gray-400 shadow-sm text-xs">
                                        <i :class="getExpenseIcon(item.category)"></i>
                                    </div>
                                    <div>
                                        <div class="font-medium text-sm text-gray-700">{{ item.name }}</div>
                                        <div class="text-[10px] text-gray-400">{{ item.category }}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold font-mono text-gray-800 text-sm">
                                        <span class="text-xs text-gray-400 mr-1">{{ item.currency }}</span>{{ item.amount.toLocaleString() }}
                                    </div>
                                    <div v-if="item.currency === 'JPY'" class="text-[10px] text-gray-400">
                                        ‚âà NT${{ Math.round(item.amount * exchangeRate).toLocaleString() }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Êñ∞Â¢ûË®òÂ∏≥ Bar -->
                <div class="absolute bottom-20 left-4 right-4 bg-white shadow-xl rounded-2xl p-4 border border-gray-100 flex flex-col gap-3">
                    <div class="flex gap-2">
                        <input v-model="newExpense.name" placeholder="È†ÖÁõÆ" class="flex-[2] bg-gray-50 rounded-lg px-3 py-2 text-sm border-none focus:ring-1 focus:ring-primary">
                        <select v-model="newExpense.category" class="flex-1 bg-gray-50 rounded-lg text-sm border-none">
                            <option value="È£ü">È£ü</option>
                            <option value="Ë°å">Ë°å</option>
                            <option value="Áé©">Áé©</option>
                            <option value="Ë≥º">Ë≥º</option>
                            <option value="‰Ωè">‰Ωè</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex rounded-lg bg-gray-50 p-1">
                            <button @click="newExpense.currency = 'JPY'" :class="{'bg-white shadow text-accent': newExpense.currency === 'JPY'}" class="px-3 py-1 rounded text-xs font-bold transition">JPY</button>
                            <button @click="newExpense.currency = 'TWD'" :class="{'bg-white shadow text-green-600': newExpense.currency === 'TWD'}" class="px-3 py-1 rounded text-xs font-bold transition">TWD</button>
                        </div>
                        <input v-model.number="newExpense.amount" type="number" placeholder="ÈáëÈ°ç" class="flex-1 bg-gray-50 rounded-lg px-3 py-2 text-sm font-mono border-none focus:ring-1 focus:ring-primary">
                        <button @click="addExpense" class="bg-gray-800 text-white px-4 rounded-lg font-bold"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>

            <!-- 4. Ë≥áË®äÁ´ô (Info) -->
            <div v-if="currentTab === 'info'" class="h-full overflow-y-auto p-4 pb-24 bg-gray-50">
                <div class="grid gap-4">
                    <!-- ÂçÄÂ°äÔºöÁ∑äÊÄ•ËàáËà™Áè≠ -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm border-l-4 border-red-400">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-exclamation-circle text-red-400"></i> Á∑äÊÄ•ËàáËà™Áè≠
                        </h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between border-b border-gray-100 pb-2">
                                <span class="text-gray-500">ÂéªÁ®ãËà™Áè≠</span>
                                <span class="font-mono font-bold">IT262 (11:30 TPE)</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-2">
                                <span class="text-gray-500">ÂõûÁ®ãËà™Áè≠</span>
                                <span class="font-mono font-bold">IT263 (15:55 OKJ)</span>
                            </div>
                            <div class="flex justify-between items-center pt-1">
                                <span class="text-gray-500">Á∑äÊÄ•ÈõªË©±</span>
                                <a href="tel:119" class="bg-red-50 text-red-600 px-3 py-1 rounded-full text-xs font-bold">119 (ÁÅ´/ÈÜ´)</a>
                            </div>
                        </div>
                    </div>

                    <!-- ÂçÄÂ°äÔºöGoogle Âú∞ÂúñÈÄ£Áµê -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-map-marked-alt text-blue-500"></i> Âú∞ÂúñÂ∑•ÂÖ∑
                        </h3>
                        <div class="grid grid-cols-2 gap-3">
                            <a :href="`https://www.google.com/maps/dir/?api=1&destination=Via+Inn+Okayama`" target="_blank" class="bg-blue-50 text-blue-600 p-3 rounded-xl text-center text-sm font-medium hover:bg-blue-100 transition">
                                <i class="fas fa-hotel mb-1 block text-lg"></i> Â∞éËà™ÂõûÈ£ØÂ∫ó
                            </a>
                            <a :href="`https://www.google.com/maps/search/?api=1&query=Convenience+Store+Near+Me`" target="_blank" class="bg-green-50 text-green-600 p-3 rounded-xl text-center text-sm font-medium hover:bg-green-100 transition">
                                <i class="fas fa-store mb-1 block text-lg"></i> ÈôÑËøëË∂ÖÂïÜ
                            </a>
                            <a :href="`https://www.google.com/maps/search/?api=1&query=Drugstore+Near+Me`" target="_blank" class="bg-yellow-50 text-yellow-600 p-3 rounded-xl text-center text-sm font-medium hover:bg-yellow-100 transition">
                                <i class="fas fa-capsules mb-1 block text-lg"></i> ÈôÑËøëËó•Â¶ù
                            </a>
                             <a :href="`https://www.google.com/maps/search/?api=1&query=Station+Near+Me`" target="_blank" class="bg-gray-100 text-gray-600 p-3 rounded-xl text-center text-sm font-medium hover:bg-gray-200 transition">
                                <i class="fas fa-subway mb-1 block text-lg"></i> ÈôÑËøëËªäÁ´ô
                            </a>
                        </div>
                    </div>

                    <!-- ÂçÄÂ°äÔºöÂÇôÁî®ÊôØÈªû -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                         <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-umbrella text-purple-500"></i> ÂÇôÁî®/Èõ®Â§©ÊñπÊ°à
                        </h3>
                        <div class="space-y-3">
                            <div class="bg-purple-50 p-3 rounded-xl">
                                <h4 class="font-bold text-purple-700 text-sm">üõçÔ∏è ÂÄâÊï∑‰∏â‰∫ï Outlet</h4>
                                <p class="text-xs text-purple-500 mt-1">ÂÄâÊï∑ËªäÁ´ôÂåóÂè£ÔºåÂÆ§ÂÖßÂ•ΩÈÄõÔºåÈõ®Â§©È¶ñÈÅ∏„ÄÇ</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Mitsui+Outlet+Park+Kurashiki" target="_blank" class="block mt-2 text-right text-xs text-purple-600 underline">Â∞éËà™ÂâçÂæÄ</a>
                            </div>
                             <div class="bg-purple-50 p-3 rounded-xl">
                                <h4 class="font-bold text-purple-700 text-sm">üåä ÂÖíÂ≥∂/È∑≤ÁæΩÂ±±</h4>
                                <p class="text-xs text-purple-500 mt-1">Â§©Ê∞£Â•Ω‰∏çÊÉ≥Áà¨Â±±ÊôÇÁöÑÁúãÊµ∑ÂÇôÊ°à„ÄÇ</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Washuzan+Observatory" target="_blank" class="block mt-2 text-right text-xs text-purple-600 underline">Â∞éËà™ÂâçÂæÄ</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Â∫ïÈÉ®Â∞éËà™Ê¨Ñ -->
        <nav class="bg-white border-t border-gray-100 h-[80px] flex justify-around items-center px-2 pb-5 pt-2 shadow-[0_-5px_15px_-5px_rgba(0,0,0,0.05)] z-40 rounded-t-2xl">
            <div @click="currentTab = 'todo'" :class="['nav-item flex flex-col items-center p-2 w-16 cursor-pointer', currentTab === 'todo' ? 'active' : 'text-gray-300']">
                <i class="fas fa-check-square text-xl mb-1"></i>
                <span class="text-[10px] font-medium">ÂæÖËæ¶</span>
            </div>
            <div @click="currentTab = 'schedule'" :class="['nav-item flex flex-col items-center p-2 w-16 cursor-pointer', currentTab === 'schedule' ? 'active' : 'text-gray-300']">
                <i class="fas fa-map-location-dot text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Ë°åÁ®ã</span>
            </div>
            <div @click="currentTab = 'wallet'" :class="['nav-item flex flex-col items-center p-2 w-16 cursor-pointer', currentTab === 'wallet' ? 'active' : 'text-gray-300']">
                <i class="fas fa-wallet text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Ë®òÂ∏≥</span>
            </div>
            <div @click="currentTab = 'info'" :class="['nav-item flex flex-col items-center p-2 w-16 cursor-pointer', currentTab === 'info' ? 'active' : 'text-gray-300']">
                <i class="fas fa-info-circle text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Ë≥áË®ä</span>
            </div>
        </nav>

        <!-- Êñ∞Â¢û/Á∑®ËºØË°åÁ®ã Modal -->
        <div v-if="showEventModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center">
            <div class="bg-[#FEFCE8] w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">{{ isEditing ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }}</h3>
                    <button @click="showEventModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                </div>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                         <!-- ÊôÇÈñì -->
                        <div>
                            <label class="text-xs text-gray-500 font-bold block mb-1">ÊôÇÈñì</label>
                            <input v-model="eventForm.time" type="time" class="w-full bg-white border border-gray-200 rounded-xl p-3 focus:outline-none focus:border-primary">
                        </div>
                        <!-- ÂàÜÈ°û (‰∏ãÊãâ) -->
                        <div>
                            <label class="text-xs text-gray-500 font-bold block mb-1">ÂàÜÈ°û</label>
                            <select v-model="eventForm.category" class="w-full bg-white border border-gray-200 rounded-xl p-3 focus:outline-none focus:border-primary">
                                <option value="sightseeing">üì∏ ÊôØÈªû</option>
                                <option value="transport">üöÖ ‰∫§ÈÄö</option>
                                <option value="food">üç± ÁæéÈ£ü</option>
                                <option value="shopping">üõçÔ∏è Ë≥ºÁâ©</option>
                                <option value="flight">‚úàÔ∏è Ëà™Áè≠</option>
                                <option value="other">üí§ ÂÖ∂‰ªñ</option>
                            </select>
                        </div>
                    </div>

                    <!-- Ê®ôÈ°å -->
                    <div>
                        <label class="text-xs text-gray-500 font-bold block mb-1">Ë°åÁ®ãÂêçÁ®±</label>
                        <input v-model="eventForm.title" type="text" placeholder="‰æãÔºöÂß¨Ë∑ØÂüé" class="w-full bg-white border border-gray-200 rounded-xl p-3 focus:outline-none focus:border-primary">
                    </div>

                    <!-- Âú∞Èªû -->
                    <div>
                        <label class="text-xs text-gray-500 font-bold block mb-1">Google Maps Âú∞Èªû (Áî®ÊñºÂ∞éËà™)</label>
                        <input v-model="eventForm.location" type="text" placeholder="‰æãÔºöHimeji Castle" class="w-full bg-white border border-gray-200 rounded-xl p-3 focus:outline-none focus:border-primary">
                    </div>

                    <!-- ÊôØÈªûÂ∞àÂ±¨Ê¨Ñ‰Ωç -->
                    <div v-if="eventForm.category === 'sightseeing'" class="bg-yellow-50 p-4 rounded-xl border border-yellow-100 space-y-3">
                        <div class="text-xs text-yellow-700 font-bold mb-1"><i class="fas fa-star"></i> ÊôØÈªûË£úÂÖÖË≥áË®ä</div>
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">ÈôÑËøëÁæéÈ£üÊé®Ëñ¶</label>
                            <input v-model="eventForm.restaurant" placeholder="‰æãÔºöTamagoya ÈõûËõãÊãåÈ£Ø" class="w-full bg-white border border-yellow-200 rounded-lg p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">ÈôÑËøëÂªÅÊâÄ/‰ºëÊÅØÈªû</label>
                            <input v-model="eventForm.toilet" placeholder="‰æãÔºöÂîÆÁ•®Âè£ÊóÅÊúâÂÖ¨ÂªÅ" class="w-full bg-white border border-yellow-200 rounded-lg p-2 text-sm">
                        </div>
                    </div>

                    <!-- ÂÇôË®ª -->
                    <div>
                        <label class="text-xs text-gray-500 font-bold block mb-1">ÂÇôË®ª</label>
                        <textarea v-model="eventForm.note" rows="3" placeholder="Á•®Âà∏Ë≥áË®ä„ÄÅÊ≥®ÊÑè‰∫ãÈ†Ö..." class="w-full bg-white border border-gray-200 rounded-xl p-3 focus:outline-none focus:border-primary"></textarea>
                    </div>
                </div>

                <div class="mt-8 flex gap-3">
                    <button @click="showEventModal = false" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold">ÂèñÊ∂à</button>
                    <button @click="saveEvent" class="flex-1 py-3 bg-gray-800 text-white rounded-xl font-bold shadow-lg">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>

        <!-- Ë≥ºÁâ©Ê∏ÖÂñÆ Modal -->
        <div v-if="showShoppingModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl h-[70vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg"><i class="fas fa-shopping-cart text-accent mr-2"></i>Ë≥ºÁâ©Ê∏ÖÂñÆ</h3>
                    <button @click="showShoppingModal = false" class="text-gray-400"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <input v-model="newShoppingItem" @keyup.enter="addShoppingItem" placeholder="Êñ∞Â¢ûÂæÖË≤∑Áâ©ÂìÅ..." class="flex-1 bg-gray-50 border-none rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-accent">
                    <button @click="addShoppingItem" class="bg-accent text-white w-10 rounded-lg"><i class="fas fa-plus"></i></button>
                </div>

                <div class="flex-1 overflow-y-auto space-y-2">
                    <div v-for="item in shoppingList" :key="item.id" class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg group">
                        <input type="checkbox" v-model="item.done" class="w-4 h-4 accent-accent rounded cursor-pointer">
                        <span :class="{'line-through text-gray-300': item.done}" class="flex-1 text-sm">{{ item.text }}</span>
                        <button @click="shoppingList = shoppingList.filter(i => i.id !== item.id)" class="text-gray-200 hover:text-red-400"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-t text-xs text-center text-gray-400">
                    ÂÖ± {{ shoppingList.length }} È†ÖÔºåÈÇÑÂâ© {{ shoppingList.filter(i=>!i.done).length }} È†Ö
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, reactive, watch, nextTick } = Vue;

        createApp({
            setup() {
                // --- ÁãÄÊÖã ---
                const currentTab = ref('todo'); // È†êË®≠È¶ñÈ†ÅÁÇ∫ Todo
                const currentDayIndex = ref(0);
                const showEventModal = ref(false);
                const showShoppingModal = ref(false);
                const isEditing = ref(false);
                const editingId = ref(null);
                const exchangeRate = ref(0.22);
                
                // ÊãñÊõ≥ÊéíÂ∫èÁõ∏Èóú
                const sortableContainer = ref(null);
                let sortableInstance = null;

                // --- Ë≥áÊñôÁµêÊßã ---
                
                // 1. ÂæÖËæ¶‰∫ãÈ†Ö
                const newTodoText = ref('');
                const todos = ref([
                    { text: 'Ë≥ºË≤∑ JR Pass', done: false },
                    { text: 'È†êÁ¥ÑÂú∞‰∏≠ÁæéË°ìÈ§® (Ëã•Ë¶ÅÂéª)', done: false },
                    { text: 'Â°´ÂØ´ VJW ÂÖ•Â¢ÉÂØ©Êü•', done: false },
                    { text: 'ÈñãÈÄöÁ∂≤Âç°Êº´ÈÅä', done: false }
                ]);

                // 2. Ë≥ºÁâ©Ê∏ÖÂñÆ
                const newShoppingItem = ref('');
                const shoppingList = ref([
                    { id: 1, text: 'ÂêâÂÇôÁ≥∞Â≠ê', done: false },
                    { id: 2, text: 'ÂêàÂà©‰ªñÂëΩ', done: false },
                    { id: 3, text: 'ÁôΩÊ°ÉÊûúÂáç', done: false }
                ]);

                // 3. Ë°åÁ®ãË≥áÊñô (Âê´ÂàÜÈ°û„ÄÅÊôØÈªûÊ¨Ñ‰Ωç)
                const itinerary = ref([
                    {
                        dayLabel: 'D1', shortDate: '12/12', dateStr: '2025-12-12',
                        events: [
                            { id: 'e1', time: '15:05', category: 'flight', title: 'ÊäµÈÅîÂ≤°Â±±Ê©üÂ†¥', location: 'Â≤°Â±±Ê°ÉÂ§™ÈÉéÊ©üÂ†¥', note: 'IT262 Ëà™Áè≠', lat: 34.757, lng: 133.855 },
                            { id: 'e2', time: '16:00', category: 'transport', title: 'Âà©Êú®Ê¥•Â∑¥Â£´', location: 'Â≤°Â±±ËªäÁ´ôË•øÂè£', note: 'ÂæÄÂ∏ÇÂçÄ', lat: 34.666, lng: 133.918 },
                            { id: 'e3', time: '17:30', category: 'food', title: 'Âë≥Âè∏ ÈáéÊùë', location: 'Âë≥Âè∏ÈáéÊùë', note: 'Â§öËúúÈÜ¨Ë±¨Êéí‰∏º', lat: 34.668, lng: 133.922 }
                        ]
                    },
                    {
                        dayLabel: 'D2', shortDate: '12/13', dateStr: '2025-12-13',
                        events: [
                            { id: 'e4', time: '08:39', category: 'transport', title: 'JR ‰ºØÂÇôÁ∑ö', location: 'Â≤°Â±±ËªäÁ´ô', note: 'ÂâçÂæÄÂÇô‰∏≠È´òÊ¢Å', lat: 34.666, lng: 133.918 },
                            { id: 'e5', time: '10:30', category: 'sightseeing', title: 'ÂÇô‰∏≠ÊùæÂ±±Âüé', location: 'ÂÇô‰∏≠ÊùæÂ±±Âüé', note: 'Â§©Á©∫‰πãÂüé', restaurant: 'È´òÊ¢ÅÂ∏ÇÂúñÊõ∏È§® Starbucks', toilet: 'ÁôªÂ±±Âè£ÊúâÂÖ¨ÂªÅ', isDone: false, lat: 34.808, lng: 133.622 }
                        ]
                    },
                    { dayLabel: 'D3', shortDate: '12/14', dateStr: '2025-12-14', events: [] },
                    { dayLabel: 'D4', shortDate: '12/15', dateStr: '2025-12-15', events: [] },
                    { dayLabel: 'D5', shortDate: '12/16', dateStr: '2025-12-16', events: [] },
                    { dayLabel: 'D6', shortDate: '12/17', dateStr: '2025-12-17', events: [] }
                ]);

                // 4. Ë®òÂ∏≥Ë≥áÊñô (ÈõôÂπ£)
                const expenses = ref([
                    { id: 1, date: '2025-12-12', name: 'Ê©üÂ†¥Â∑¥Â£´', category: 'Ë°å', currency: 'JPY', amount: 780 },
                    { id: 2, date: '2025-12-12', name: 'Via Inn ‰ΩèÂÆø', category: '‰Ωè', currency: 'TWD', amount: 12000 }
                ]);

                // Ë°®ÂñÆ Reactive Objects
                const eventForm = reactive({
                    id: null, time: '', category: 'sightseeing', title: '', location: '', note: '', 
                    restaurant: '', toilet: '', isDone: false
                });

                const newExpense = reactive({
                    name: '', category: 'È£ü', currency: 'JPY', amount: ''
                });

                // --- Computed ---
                const headerTitle = computed(() => {
                    const map = { 'todo': 'Ë°åÂâçÊ∫ñÂÇô', 'schedule': 'Ë°åÁ®ãË¶èÂäÉ', 'wallet': 'ÊóÖË≤ªË®òÂ∏≥', 'info': 'Ë≥áË®äÁ´ô' };
                    return map[currentTab.value];
                });

                const currentItinerary = computed(() => itinerary.value[currentDayIndex.value]);

                // Ë®òÂ∏≥Ë®àÁÆó
                const expensesByDay = computed(() => {
                    const grouped = {};
                    // ÂÖà‰æùÊó•ÊúüÊéíÂ∫è
                    const sorted = [...expenses.value].sort((a,b) => new Date(a.date) - new Date(b.date));
                    
                    sorted.forEach(item => {
                        // ËΩâÊèõÈ°ØÁ§∫ÂêçÁ®± (D1, D2...)
                        const dayObj = itinerary.value.find(d => d.dateStr === item.date);
                        const key = dayObj ? `${dayObj.dayLabel} (${dayObj.shortDate})` : item.date;
                        
                        if(!grouped[key]) grouped[key] = [];
                        grouped[key].push(item);
                    });
                    return grouped;
                });

                const calculateDayTotalTWD = (items) => {
                    return Math.round(items.reduce((sum, item) => {
                        return sum + (item.currency === 'JPY' ? item.amount * exchangeRate.value : item.amount);
                    }, 0));
                };

                const grandTotalTWD = computed(() => {
                    return Math.round(expenses.value.reduce((sum, item) => {
                        return sum + (item.currency === 'JPY' ? item.amount * exchangeRate.value : item.amount);
                    }, 0));
                });

                // --- Methods ---

                // 1. Todo & Shopping
                const addTodo = () => {
                    if(!newTodoText.value) return;
                    todos.value.push({ text: newTodoText.value, done: false });
                    newTodoText.value = '';
                };
                const addShoppingItem = () => {
                    if(!newShoppingItem.value) return;
                    shoppingList.value.push({ id: Date.now(), text: newShoppingItem.value, done: false });
                    newShoppingItem.value = '';
                };

                // 2. Schedule
                const switchDay = (index) => {
                    currentDayIndex.value = index;
                    initSortable(); // ÂàáÊèõÂ§©Êï∏ÂæåÈáçÊñ∞Á∂ÅÂÆöÊãñÊõ≥
                    fetchWeather();
                };

                const initSortable = () => {
                    nextTick(() => {
                        if (sortableInstance) sortableInstance.destroy();
                        if (sortableContainer.value) {
                            sortableInstance = new Sortable(sortableContainer.value, {
                                handle: '.handle', // Âè™ÊúâÊåâ‰ΩèÊääÊâãÊâçËÉΩÊãñÊõ≥
                                animation: 150,
                                ghostClass: 'sortable-ghost',
                                dragClass: 'sortable-drag',
                                onEnd: (evt) => {
                                    // Êõ¥Êñ∞Êï∏ÊìöÈ†ÜÂ∫è
                                    const item = currentItinerary.value.events.splice(evt.oldIndex, 1)[0];
                                    currentItinerary.value.events.splice(evt.newIndex, 0, item);
                                }
                            });
                        }
                    });
                };

                const openAddModal = () => {
                    isEditing.value = false;
                    Object.assign(eventForm, { 
                        id: Date.now(), time: '', category: 'sightseeing', title: '', 
                        location: '', note: '', restaurant: '', toilet: '', isDone: false 
                    });
                    showEventModal.value = true;
                };

                const editEvent = (idx) => {
                    isEditing.value = true;
                    const event = currentItinerary.value.events[idx];
                    editingId.value = event.id;
                    Object.assign(eventForm, JSON.parse(JSON.stringify(event)));
                    showEventModal.value = true;
                };

                const saveEvent = () => {
                    if (isEditing.value) {
                        const idx = currentItinerary.value.events.findIndex(e => e.id === editingId.value);
                        if (idx !== -1) currentItinerary.value.events[idx] = { ...eventForm };
                    } else {
                        currentItinerary.value.events.push({ ...eventForm });
                        // Êñ∞Â¢ûÂæå‰æùÊôÇÈñìËá™ÂãïÊéíÂ∫è (ÂèØÈÅ∏ÔºåËã•ÂñúÊ≠°ÊâãÂãïÊãñÊõ≥ÂèØÊãøÊéâ)
                        currentItinerary.value.events.sort((a, b) => a.time.localeCompare(b.time));
                    }
                    showEventModal.value = false;
                    fetchWeather();
                };

                const deleteEvent = (idx) => {
                    if(confirm('Âà™Èô§Ê≠§Ë°åÁ®ãÔºü')) currentItinerary.value.events.splice(idx, 1);
                };

                // ËºîÂä©È°ØÁ§∫
                const getCategoryIcon = (cat) => {
                    const map = {
                        sightseeing: 'fas fa-camera', transport: 'fas fa-train', food: 'fas fa-utensils',
                        shopping: 'fas fa-shopping-bag', flight: 'fas fa-plane', other: 'fas fa-bed'
                    };
                    return map[cat] || 'fas fa-circle';
                };

                const getCategoryColor = (cat) => {
                    const map = {
                        sightseeing: 'bg-red-400', transport: 'bg-blue-400', food: 'bg-orange-400',
                        shopping: 'bg-purple-400', flight: 'bg-indigo-400', other: 'bg-gray-400'
                    };
                    return map[cat] || 'bg-gray-400';
                };
                
                // Google Maps Â∞éËà™ÈÄ£ÁµêÁîüÊàê
                const getGoogleNavUrl = (location) => {
                    if (!location) return '#';
                    return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(location)}`;
                };

                // Â§©Ê∞£ Mock (Ëá™ÂãïÊäìÂèñ API ÈÇèËºØËàá‰∏ä‰∏ÄÁâàÁõ∏ÂêåÔºåÊ≠§ËôïÁï•ÂÅöÁ∞°ÂåñÊºîÁ§∫)
                const fetchWeather = async () => {
                     // ÂØ¶ÈöõÊáâÁî®ÂèØÂú®Ê≠§ÂëºÂè´ Open-Meteo API
                     // ÈÄôË£°ÁÇ∫‰∫ÜÁØÑ‰æãÁ©©ÂÆöÊÄßÔºåÁõ¥Êé•ÂõûÂÇ≥Ê®°Êì¨Êï∏Êìö
                     currentItinerary.value.events.forEach(e => {
                         if(!e.weather) e.weather = Math.floor(Math.random() * (12 - 5 + 1) + 5);
                     });
                };

                // 3. Wallet
                const getExpenseIcon = (cat) => {
                    const map = { 'È£ü': 'fas fa-utensils', 'Ë°å': 'fas fa-bus', 'Áé©': 'fas fa-ticket-alt', 'Ë≥º': 'fas fa-shopping-bag', '‰Ωè': 'fas fa-bed' };
                    return map[cat] || 'fas fa-yen-sign';
                };

                const addExpense = () => {
                    if(!newExpense.name || !newExpense.amount) return;
                    // Ëá™ÂãïÂ∏∂ÂÖ•Áï∂ÂâçÈÅ∏ÊìáÊó•ÊúüÁöÑÊó•Êúü
                    const todayStr = currentItinerary.value.dateStr;
                    
                    expenses.value.push({
                        id: Date.now(),
                        date: todayStr,
                        ...newExpense
                    });
                    newExpense.name = '';
                    newExpense.amount = '';
                };

                // Lifecycle
                onMounted(() => {
                    initSortable();
                    fetchWeather();
                });

                // Watchers
                watch(currentTab, (val) => {
                    if(val === 'schedule') initSortable();
                });

                return {
                    currentTab, headerTitle,
                    // Todo
                    newTodoText, todos, addTodo,
                    // Shopping
                    shoppingList, newShoppingItem, addShoppingItem, showShoppingModal,
                    // Schedule
                    itinerary, currentDayIndex, currentItinerary, switchDay,
                    showEventModal, isEditing, eventForm, openAddModal, editEvent, saveEvent, deleteEvent,
                    getCategoryIcon, getCategoryColor, getGoogleNavUrl, sortableContainer,
                    // Wallet
                    expenses, expensesByDay, newExpense, addExpense, getExpenseIcon,
                    exchangeRate, calculateDayTotalTWD, grandTotalTWD
                };
            }
        }).mount('#app');
    </script>
</body>
</html>